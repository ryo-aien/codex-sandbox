# Guardrails configuration (reviewed + subshell prohibition)
# Default stance: require confirmation unless explicitly allowlisted.
defaults:
  decision: require_confirmation
  blocked_message: >
    Guardrail ${rule_id} blocked: ${command}

rules:
  # -- New: 0) Disallow subshell invocation (bash -c / sh -c / eval / backticks)
  - id: block-subshell-invocation
    description: Block subshell execution via bash -c, sh -c, eval, and backticks (including with &&, ||, ;)
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;|&&|\\|\\|)\\s*bash\\s+-c\\s+["\\\']'
          - regex: '(^|;|&&|\\|\\|)\\s*sh\\s+-c\\s+["\\\']'
          - regex: '\\beval\\s+'
          - regex: '`[^`]+`'
    then:
      action: block
      message: 'Subshell invocation (bash -c / sh -c / eval / backticks) is forbidden. Break complex commands into plan steps or provide argv-form commands.'

  # 1) Dangerous privilege/disk operations
  - id: block-priv-escalation-and-disk
    description: Block sudo, dd, mkfs, fork-bomb, and destructive redirections
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\\s*sudo\\b'
          - regex: '(^|;)\\s*dd\\b'
          - regex: '(^|;)\\s*mkfs\\w*\\b'
          - regex: ':\\(\\)\\s*\\{\\s*:\\|:\\s*;\\s*\\}\\s*;\\s*:'
          - regex: '(^|;)\\s*truncate\\s+-s\\s+0\\b'
          - regex: '(^|;)\\s*>\\s*/\\S+'
          - regex: '(^|;)\\s*:\\s*>\\s*\\S+'
    then:
      action: block
      message: 'Dangerous privilege/disk operations are not allowed.'

  # 2) rm via subshells and find/xargs delete
  - id: block-subshell-rm-and-find-delete
    description: Block rm through subshells and find/xargs delete
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\\s*(?:sh|bash)\\s+-c\\s+["\\\'].*\\brm\\b.*["\\\']'
          - regex: 'find\\s+[^;]*\\s-(?:delete|exec\\s+rm\\b)'
          - regex: 'xargs\\s+-0?\\s*rm\\b'
    then:
      action: block
      message: 'rm through subshell/find/xargs is blocked.'

  # 3) Network and global installs require confirmation
  - id: require-confirm-network-and-globals
    description: Network fetches and global installs require confirmation
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\\s*(curl|wget)\\b'
          - regex: '(^|;)\\s*pip\\s+install\\b'
          - regex: '(^|;)\\s*npm\\s+(?:i|install)\\b'
          - regex: '(^|;)\\s*yarn\\s+(?:global|add)\\b'
          - regex: '(^|;)\\s*pnpm\\s+(?:add|install)\\b'
          - regex: '(^|;)\\s*gem\\s+install\\b'
          - regex: '(^|;)\\s*go\\s+install\\b'
    then:
      action: require_confirmation
      prompt: >
        This command may fetch from the network or install global packages. Continue? (yes/no)

  # 4) Killing processes, services, containers, clusters require confirmation
  - id: require-confirm-process-and-service
    description: High-impact operations (kill, services, containers, clusters) require confirmation
    when:
      tool: shell
      command:
        any:
          - regex: '(^|;)\\s*(pkill|killall|kill\\s+-9)\\b'
          - regex: '(^|;)\\s*systemctl\\b'
          - regex: '(^|;)\\s*(docker|kubectl)\\b'
    then:
      action: require_confirmation
      prompt: 'High-impact operation. Continue? (yes/no)'

  # 5) Additional dangerous git operations
  - id: require-confirm-git-harder
    description: Additional risky git operations require confirmation
    when:
      tool: shell
      command:
        any:
          - regex: 'git\\s+reset\\s+--hard\\b'
          - regex: 'git\\s+clean\\s+-fdx\\b'
          - regex: 'git\\s+checkout\\s+-f\\b'
          - regex: 'git\\s+config\\s+--global\\b'
          - regex: 'git\\s+push\\s+--force\\b'
          - regex: 'git\\s+rebase\\b'
    then:
      action: require_confirmation
      prompt: 'This git operation is risky. Continue? (yes/no)'

  # 6) apply_patch path traversal / workspace escape
  - id: block-apply-patch-path-traversal
    description: apply_patch must not escape workspace or use path traversal
    when:
      tool: apply_patch
      target_path:
        any:
          - not_starts_with: '/workspace'
          - contains: '..'
    then:
      action: block
      message: 'apply_patch path traversal or workspace escape is blocked.'

allowlist:
  - for: shell
    commands:
      - regex: '^ls(\\s|$)'
      - regex: '^pwd(\\s|$)'
      - regex: '^cat\\b'
      - regex: '^head\\b'
      - regex: '^tail\\b'
      - regex: '^grep\\b'
      - regex: '^rg\\b'
      - regex: '^sed\\s+-n\\b'   # non-destructive viewing
      - regex: '^git\\s+status(\\s|$)'
      - regex: '^git\\s+log(\\s|$)'
      - regex: '^git\\s+diff(\\s|$)'
      - regex: '^python\\b'
      - regex: '^pytest(\\s|$)'
      - regex: '^make(\\s|$)'
